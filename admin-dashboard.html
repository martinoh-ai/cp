<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Masia Can Pares</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            --color-cream: #F5F0E1;
            --color-sage: #2D4A3E;
            --color-terracotta: #A65D57;
            --color-charcoal: #722F37;
            --color-mustard: #E9B84A;
            --color-text: #2C2825;
            --color-text-light: #6B635A;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: 'DM Sans', sans-serif;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: #f5f5f5; color: var(--color-text); line-height: 1.6; }

        /* Loading Screen */
        .loading-screen { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-screen.hidden { display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--color-charcoal); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login Required */
        .login-required { display: none; min-height: 100vh; align-items: center; justify-content: center; flex-direction: column; gap: 20px; padding: 40px; text-align: center; }
        .login-required.show { display: flex; }
        .login-required h1 { font-family: var(--font-display); font-size: 1.5rem; }
        .login-required a { padding: 15px 30px; background: var(--color-charcoal); color: white; text-decoration: none; font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; }

        /* Main App */
        .admin-app { display: none; }
        .admin-app.show { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--color-charcoal); color: white; position: fixed; top: 0; left: 0; bottom: 0; display: flex; flex-direction: column; }
        .sidebar__header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar__logo { height: 35px; filter: brightness(0) invert(1); margin-bottom: 8px; }
        .sidebar__title { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; opacity: 0.6; }
        .sidebar__nav { flex: 1; padding: 20px 0; }
        .sidebar__link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.3s; }
        .sidebar__link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar__link.active { background: rgba(255,255,255,0.1); color: white; border-left: 3px solid var(--color-mustard); }
        .sidebar__link .material-symbols-outlined { font-size: 20px; }
        .sidebar__badge { margin-left: auto; background: var(--color-terracotta); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
        .sidebar__footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar__user { display: flex; align-items: center; gap: 12px; }
        .sidebar__avatar { width: 40px; height: 40px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .sidebar__logout { margin-top: 15px; width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; color: white; font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border-radius: 6px; }
        .sidebar__logout:hover { background: rgba(255,255,255,0.15); }

        /* Main */
        .main { flex: 1; margin-left: 260px; }
        .main__header { background: white; padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .main__title { font-family: var(--font-display); font-size: 1.4rem; font-weight: 600; }
        .main__content { padding: 30px; }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 25px; }
        .stat-card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .stat-card__icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .stat-card__icon--blue { background: rgba(45, 74, 62, 0.1); color: var(--color-sage); }
        .stat-card__icon--orange { background: rgba(166, 93, 87, 0.1); color: var(--color-terracotta); }
        .stat-card__icon--yellow { background: rgba(233, 184, 74, 0.15); color: #b8860b; }
        .stat-card__icon--purple { background: rgba(114, 47, 55, 0.1); color: var(--color-charcoal); }
        .stat-card__value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .stat-card__label { font-size: 0.85rem; color: var(--color-text-light); }

        /* Card */
        .card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .card__header { padding: 20px 25px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; }
        .card__title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card__body { padding: 25px; }

        /* Table */
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px 15px; font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-light); border-bottom: 1px solid rgba(0,0,0,0.08); }
        .table td { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .table tr:hover { background: rgba(0,0,0,0.02); }
        .table__status { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .table__status--confirmed { background: rgba(45, 74, 62, 0.1); color: var(--color-sage); }
        .table__status--pending { background: rgba(233, 184, 74, 0.2); color: #9a7a00; }
        .table__status--incomplete { background: rgba(166, 93, 87, 0.1); color: var(--color-terracotta); }
        .table__action { padding: 8px 15px; background: var(--color-cream); border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-right: 8px; }
        .table__action:hover { background: #e5e0d1; }
        .table__action--primary { background: var(--color-charcoal); color: white; }

        /* Messages */
        .messages-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 180px); }
        .conversations-list { background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .conversations-list__header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .conversations-list__items { flex: 1; overflow-y: auto; }
        .conversation-item { padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.04); cursor: pointer; transition: background 0.2s; }
        .conversation-item:hover, .conversation-item.active { background: var(--color-cream); }
        .conversation-item__header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .conversation-item__avatar { width: 40px; height: 40px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85rem; }
        .conversation-item__name { font-weight: 600; flex: 1; }
        .conversation-item__time { font-size: 0.75rem; color: var(--color-text-light); }
        .conversation-item__preview { font-size: 0.85rem; color: var(--color-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-item__unread { width: 8px; height: 8px; background: var(--color-terracotta); border-radius: 50%; margin-left: 10px; }

        .chat-panel { background: white; border-radius: 12px; display: flex; flex-direction: column; }
        .chat-panel__header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 15px; }
        .chat-panel__info h3 { font-weight: 600; }
        .chat-panel__info p { font-size: 0.85rem; color: var(--color-text-light); }
        .chat-panel__messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { max-width: 70%; }
        .chat-message--received { align-self: flex-start; }
        .chat-message--sent { align-self: flex-end; }
        .chat-message__bubble { padding: 12px 18px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; }
        .chat-message--received .chat-message__bubble { background: var(--color-cream); border-bottom-left-radius: 4px; }
        .chat-message--sent .chat-message__bubble { background: var(--color-charcoal); color: white; border-bottom-right-radius: 4px; }
        .chat-message__time { font-size: 0.7rem; color: var(--color-text-light); margin-top: 5px; }
        .chat-message--sent .chat-message__time { text-align: right; }
        .chat-panel__input { padding: 20px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; gap: 15px; }
        .chat-panel__input input { flex: 1; padding: 14px 18px; border: 1px solid rgba(0,0,0,0.12); border-radius: 25px; font-size: 0.95rem; }
        .chat-panel__input input:focus { outline: none; border-color: var(--color-charcoal); }
        .chat-panel__send { width: 48px; height: 48px; background: var(--color-charcoal); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
        .chat-panel__send:hover { background: var(--color-terracotta); }
        .chat-panel__whatsapp { padding: 10px 20px; background: #25D366; color: white; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        /* Check-in Details */
        .checkin-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .guest-card { background: var(--color-cream); border-radius: 10px; padding: 20px; }
        .guest-card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .guest-card__name { font-weight: 600; }
        .guest-card__status { padding: 4px 10px; border-radius: 10px; font-size: 0.7rem; }
        .guest-card__status--complete { background: rgba(45, 74, 62, 0.15); color: var(--color-sage); }
        .guest-card__row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 0.9rem; }
        .guest-card__row:last-child { border-bottom: none; }
        .guest-card__label { color: var(--color-text-light); }
        .guest-card__id-link { color: var(--color-charcoal); text-decoration: underline; cursor: pointer; }

        /* Issues */
        .issue-card { background: var(--color-cream); border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--color-mustard); }
        .issue-card--high { border-color: var(--color-terracotta); }
        .issue-card--low { border-color: var(--color-sage); }
        .issue-card__header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .issue-card__location { font-weight: 600; }
        .issue-card__severity { font-size: 0.7rem; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; background: rgba(0,0,0,0.1); }
        .issue-card__desc { color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 10px; }
        .issue-card__meta { font-size: 0.8rem; color: var(--color-text-light); }
        .issue-card__actions { margin-top: 15px; display: flex; gap: 10px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--color-text-light); }
        .empty-state .material-symbols-outlined { font-size: 64px; opacity: 0.3; margin-bottom: 20px; }

        /* Mobile */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .messages-layout { grid-template-columns: 1fr; }
            .checkin-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Required -->
    <div class="login-required" id="login-required">
        <span class="material-symbols-outlined" style="font-size:64px;color:var(--color-terracotta);">lock</span>
        <h1>Admin Access Required</h1>
        <p>Please log in with your admin account.</p>
        <a href="login-firebase.html">Go to Login</a>
    </div>

    <!-- Admin App -->
    <div class="admin-app" id="admin-app">
        <aside class="sidebar">
            <div class="sidebar__header">
                <img src="https://images.squarespace-cdn.com/content/v1/66d829452bae803f6b32068e/8fb7c7fc-6e43-406c-b1c0-a65a59062cf6/CanPares_2-01.png?format=500w" alt="Can Pares" class="sidebar__logo">
                <div class="sidebar__title">Admin Dashboard</div>
            </div>
            <nav class="sidebar__nav">
                <div class="sidebar__link active" data-tab="overview">
                    <span class="material-symbols-outlined">dashboard</span>
                    Overview
                </div>
                <div class="sidebar__link" data-tab="bookings">
                    <span class="material-symbols-outlined">calendar_month</span>
                    Bookings
                </div>
                <div class="sidebar__link" data-tab="messages">
                    <span class="material-symbols-outlined">chat</span>
                    Messages
                    <span class="sidebar__badge" id="unread-count">0</span>
                </div>
                <div class="sidebar__link" data-tab="checkins">
                    <span class="material-symbols-outlined">how_to_reg</span>
                    Check-ins
                </div>
                <div class="sidebar__link" data-tab="issues">
                    <span class="material-symbols-outlined">report_problem</span>
                    Issues
                    <span class="sidebar__badge" id="issues-badge">0</span>
                </div>
                <div class="sidebar__link" data-tab="cleaning">
                    <span class="material-symbols-outlined">cleaning_services</span>
                    Cleaning
                </div>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__avatar">M</div>
                    <div>
                        <div style="font-size:0.9rem;font-weight:500;">Martin</div>
                        <div style="font-size:0.75rem;opacity:0.6;">Admin</div>
                    </div>
                </div>
                <button class="sidebar__logout" onclick="logout()">
                    <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;margin-right:5px;">logout</span>
                    Sign Out
                </button>
            </div>
        </aside>

        <main class="main">
            <header class="main__header">
                <h1 class="main__title" id="page-title">Overview</h1>
                <div style="font-family:var(--font-mono);font-size:0.8rem;color:var(--color-text-light);" id="current-date"></div>
            </header>

            <div class="main__content">
                <!-- Overview Tab -->
                <div class="tab-content active" id="overview">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--blue"><span class="material-symbols-outlined">calendar_month</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-bookings">0</div>
                            <div class="stat-card__label">Active Bookings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--orange"><span class="material-symbols-outlined">chat</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-messages">0</div>
                            <div class="stat-card__label">Unread Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--yellow"><span class="material-symbols-outlined">how_to_reg</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-checkins">0</div>
                            <div class="stat-card__label">Pending Check-ins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--purple"><span class="material-symbols-outlined">report_problem</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-issues">0</div>
                            <div class="stat-card__label">Open Issues</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">schedule</span> Upcoming Arrivals</span>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Guest</th>
                                        <th>Property</th>
                                        <th>Check-in</th>
                                        <th>Nights</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming-bookings">
                                    <tr><td colspan="6" class="empty-state" style="padding:40px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bookings Tab -->
                <div class="tab-content" id="bookings">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">calendar_month</span> All Bookings</span>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>Guest</th>
                                        <th>Property</th>
                                        <th>Dates</th>
                                        <th>Amount</th>
                                        <th>Paid</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="all-bookings">
                                    <tr><td colspan="7" class="empty-state" style="padding:40px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div class="tab-content" id="messages">
                    <div class="messages-layout">
                        <div class="conversations-list">
                            <div class="conversations-list__header">
                                <input type="text" placeholder="Search conversations..." style="width:100%;padding:10px 15px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;">
                            </div>
                            <div class="conversations-list__items" id="conversations-list">
                                <div class="empty-state" style="padding:40px;">Loading...</div>
                            </div>
                        </div>
                        <div class="chat-panel">
                            <div class="chat-panel__header" id="chat-header" style="display:none;">
                                <div class="conversation-item__avatar" id="chat-avatar">JD</div>
                                <div class="chat-panel__info">
                                    <h3 id="chat-name">Select a conversation</h3>
                                    <p id="chat-booking">-</p>
                                </div>
                                <button class="chat-panel__whatsapp" id="whatsapp-btn" style="margin-left:auto;">
                                    <span class="material-symbols-outlined">chat</span>
                                    WhatsApp
                                </button>
                            </div>
                            <div class="chat-panel__messages" id="chat-messages">
                                <div class="empty-state">
                                    <span class="material-symbols-outlined">forum</span>
                                    <p>Select a conversation to view messages</p>
                                </div>
                            </div>
                            <div class="chat-panel__input" id="chat-input" style="display:none;">
                                <input type="text" placeholder="Type your reply..." id="message-input">
                                <button class="chat-panel__send" onclick="sendMessage()">
                                    <span class="material-symbols-outlined">send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check-ins Tab -->
                <div class="tab-content" id="checkins">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">how_to_reg</span> Guest Registrations</span>
                        </div>
                        <div class="card__body" id="checkins-list">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Issues Tab -->
                <div class="tab-content" id="issues">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">report_problem</span> Reported Issues</span>
                        </div>
                        <div class="card__body" id="issues-list">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Cleaning Tab -->
                <div class="tab-content" id="cleaning">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">cleaning_services</span> Cleaning Sessions</span>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Property</th>
                                        <th>Type</th>
                                        <th>Staff</th>
                                        <th>Duration</th>
                                        <th>Issues</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="cleaning-sessions">
                                    <tr><td colspan="7" class="empty-state" style="padding:40px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">inventory_2</span> Inventory Alerts</span>
                        </div>
                        <div class="card__body" id="inventory-alerts">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // =====================================================
        // ðŸ”¥ FIREBASE CONFIG - REMPLACEZ AVEC VOS VALEURS
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlqtcXUqEctwsvLbXzGOenleNPDwOj4n4",
            authDomain: "masia-can-pares.firebaseapp.com",
            projectId: "masia-can-pares",
            storageBucket: "masia-can-pares.firebasestorage.app",
            messagingSenderId: "898469617158",
            appId: "1:898469617158:web:94f57c383501f81b9d2d87"
        };

        // ðŸ“± WHATSAPP NUMBER
        const WHATSAPP_NUMBER = "34612345678"; // Votre numÃ©ro WhatsApp Business

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // =====================================================
        // AUTH CHECK
        // =====================================================
        let currentUser = null;
        let currentConversation = null;

        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-screen').classList.add('hidden');
            
            if (user) {
                // Check if admin
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (adminDoc.exists) {
                    currentUser = user;
                    document.getElementById('admin-app').classList.add('show');
                    initDashboard();
                } else {
                    document.getElementById('login-required').classList.add('show');
                }
            } else {
                document.getElementById('login-required').classList.add('show');
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login-firebase.html';
            });
        }

        // =====================================================
        // DASHBOARD INIT
        // =====================================================
        function initDashboard() {
            // Set date
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Load data
            loadStats();
            loadBookings();
            loadConversations();
            loadCheckins();
            loadIssues();
            loadCleaningSessions();

            // Tab navigation
            document.querySelectorAll('.sidebar__link').forEach(link => {
                link.addEventListener('click', () => {
                    const tab = link.dataset.tab;
                    document.querySelectorAll('.sidebar__link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(tab).classList.add('active');
                    document.getElementById('page-title').textContent = link.textContent.trim();
                });
            });
        }

        // =====================================================
        // LOAD DATA
        // =====================================================
        async function loadStats() {
            try {
                const bookings = await db.collection('bookings').where('status', '==', 'confirmed').get();
                document.getElementById('stat-bookings').textContent = bookings.size;

                const convos = await db.collection('conversations').where('unreadByHost', '>', 0).get();
                document.getElementById('stat-messages').textContent = convos.size;
                document.getElementById('unread-count').textContent = convos.size;

                const checkins = await db.collection('checkins').where('status', '==', 'incomplete').get();
                document.getElementById('stat-checkins').textContent = checkins.size;

                const issues = await db.collection('issues').where('status', '==', 'open').get();
                document.getElementById('stat-issues').textContent = issues.size;
                document.getElementById('issues-badge').textContent = issues.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadBookings() {
            try {
                const snapshot = await db.collection('bookings').orderBy('checkIn', 'desc').limit(20).get();
                
                if (snapshot.empty) {
                    document.getElementById('upcoming-bookings').innerHTML = '<tr><td colspan="6" class="empty-state">No bookings yet</td></tr>';
                    document.getElementById('all-bookings').innerHTML = '<tr><td colspan="7" class="empty-state">No bookings yet</td></tr>';
                    return;
                }

                let upcomingHtml = '';
                let allHtml = '';

                snapshot.forEach(doc => {
                    const b = doc.data();
                    const checkIn = b.checkIn?.toDate?.() || new Date(b.checkIn);
                    const checkOut = b.checkOut?.toDate?.() || new Date(b.checkOut);
                    const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));

                    upcomingHtml += `
                        <tr>
                            <td><strong>${b.guestName || 'Guest'}</strong></td>
                            <td>${b.property || 'Casa Blanca'}</td>
                            <td>${checkIn.toLocaleDateString()}</td>
                            <td>${nights}</td>
                            <td><span class="table__status table__status--${b.status}">${b.status}</span></td>
                            <td>
                                <button class="table__action" onclick="viewBooking('${doc.id}')">View</button>
                                <a href="https://wa.me/${WHATSAPP_NUMBER}?text=Hi%20${encodeURIComponent(b.guestName || 'Guest')}!" class="table__action table__action--primary" target="_blank">WhatsApp</a>
                            </td>
                        </tr>
                    `;

                    allHtml += `
                        <tr>
                            <td>${b.refCode || doc.id.slice(0,8)}</td>
                            <td>${b.guestName || 'Guest'}</td>
                            <td>${b.property || 'Casa Blanca'}</td>
                            <td>${checkIn.toLocaleDateString()} - ${checkOut.toLocaleDateString()}</td>
                            <td>â‚¬${b.totalAmount || 0}</td>
                            <td>â‚¬${b.paidAmount || 0}</td>
                            <td><span class="table__status table__status--${b.status}">${b.status}</span></td>
                        </tr>
                    `;
                });

                document.getElementById('upcoming-bookings').innerHTML = upcomingHtml || '<tr><td colspan="6" class="empty-state">No upcoming bookings</td></tr>';
                document.getElementById('all-bookings').innerHTML = allHtml;
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        async function loadConversations() {
            try {
                const snapshot = await db.collection('conversations').orderBy('lastMessageTime', 'desc').get();
                
                if (snapshot.empty) {
                    document.getElementById('conversations-list').innerHTML = '<div class="empty-state">No conversations yet</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const time = c.lastMessageTime?.toDate?.() || new Date();
                    const initials = (c.guestName || 'G').split(' ').map(n => n[0]).join('').slice(0,2);
                    
                    html += `
                        <div class="conversation-item" onclick="openConversation('${doc.id}')">
                            <div class="conversation-item__header">
                                <div class="conversation-item__avatar">${initials}</div>
                                <span class="conversation-item__name">${c.guestName || 'Guest'}</span>
                                <span class="conversation-item__time">${time.toLocaleDateString()}</span>
                                ${c.unreadByHost > 0 ? '<span class="conversation-item__unread"></span>' : ''}
                            </div>
                            <div class="conversation-item__preview">${c.lastMessage || 'No messages'}</div>
                        </div>
                    `;
                });

                document.getElementById('conversations-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        async function openConversation(convId) {
            currentConversation = convId;
            
            // Mark all items as inactive
            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            // Get conversation info
            const convDoc = await db.collection('conversations').doc(convId).get();
            const conv = convDoc.data();

            // Update header
            const initials = (conv.guestName || 'G').split(' ').map(n => n[0]).join('').slice(0,2);
            document.getElementById('chat-avatar').textContent = initials;
            document.getElementById('chat-name').textContent = conv.guestName || 'Guest';
            document.getElementById('chat-booking').textContent = conv.bookingRef || 'Direct message';
            document.getElementById('chat-header').style.display = 'flex';
            document.getElementById('chat-input').style.display = 'flex';

            // WhatsApp link
            document.getElementById('whatsapp-btn').onclick = () => {
                window.open(`https://wa.me/${conv.guestPhone?.replace(/[^0-9]/g, '') || WHATSAPP_NUMBER}`, '_blank');
            };

            // Load messages
            const messagesSnapshot = await db.collection('conversations').doc(convId).collection('messages').orderBy('timestamp').get();
            
            let html = '';
            messagesSnapshot.forEach(doc => {
                const m = doc.data();
                const isHost = m.senderId === 'admin' || m.senderRole === 'admin';
                const time = m.timestamp?.toDate?.() || new Date();
                
                html += `
                    <div class="chat-message chat-message--${isHost ? 'sent' : 'received'}">
                        <div class="chat-message__bubble">${m.text}</div>
                        <div class="chat-message__time">${time.toLocaleString()}</div>
                    </div>
                `;
            });

            document.getElementById('chat-messages').innerHTML = html || '<div class="empty-state">No messages in this conversation</div>';
            
            // Scroll to bottom
            const msgContainer = document.getElementById('chat-messages');
            msgContainer.scrollTop = msgContainer.scrollHeight;

            // Mark as read
            await db.collection('conversations').doc(convId).update({ unreadByHost: 0 });
            loadStats();
        }

        async function sendMessage() {
            if (!currentConversation) return;
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';

            // Add message
            await db.collection('conversations').doc(currentConversation).collection('messages').add({
                text,
                senderId: 'admin',
                senderRole: 'admin',
                senderName: 'Martin',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            // Update conversation
            await db.collection('conversations').doc(currentConversation).update({
                lastMessage: text,
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                unreadByGuest: firebase.firestore.FieldValue.increment(1)
            });

            // Reload conversation
            openConversation(currentConversation);
        }

        // Enter to send
        document.getElementById('message-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function loadCheckins() {
            try {
                const snapshot = await db.collection('checkins').orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty) {
                    document.getElementById('checkins-list').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">how_to_reg</span><p>No check-in data yet</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const guests = c.guests || [];
                    
                    html += `
                        <div style="margin-bottom:30px;">
                            <h3 style="margin-bottom:15px;">Booking: ${c.bookingRef || doc.id}</h3>
                            <div class="checkin-details">
                                ${guests.map((g, i) => `
                                    <div class="guest-card">
                                        <div class="guest-card__header">
                                            <span class="guest-card__name">Guest ${i+1}: ${g.firstName} ${g.lastName}</span>
                                            <span class="guest-card__status guest-card__status--complete">Complete</span>
                                        </div>
                                        <div class="guest-card__row"><span class="guest-card__label">Date of Birth</span><span>${g.dateOfBirth || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">Nationality</span><span>${g.nationality || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">ID Type</span><span>${g.idType || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">ID Number</span><span>${g.idNumber || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">ID Document</span><span class="guest-card__id-link" onclick="viewIdDocument('${g.idDocumentUrl}')">View Document</span></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('checkins-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading checkins:', error);
            }
        }

        async function viewIdDocument(url) {
            if (url) {
                window.open(url, '_blank');
            } else {
                alert('No document uploaded');
            }
        }

        async function loadIssues() {
            try {
                const snapshot = await db.collection('issues').orderBy('reportedAt', 'desc').get();
                
                if (snapshot.empty) {
                    document.getElementById('issues-list').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">check_circle</span><p>No issues reported</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const i = doc.data();
                    const time = i.reportedAt?.toDate?.() || new Date();
                    
                    html += `
                        <div class="issue-card issue-card--${i.severity}">
                            <div class="issue-card__header">
                                <span class="issue-card__location">${i.property} - ${i.location}</span>
                                <span class="issue-card__severity">${i.severity}</span>
                            </div>
                            <p class="issue-card__desc">${i.description || 'No description'}</p>
                            <div class="issue-card__meta">Reported: ${time.toLocaleString()}</div>
                            <div class="issue-card__actions">
                                <button class="table__action" onclick="resolveIssue('${doc.id}')">Mark Resolved</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('issues-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading issues:', error);
            }
        }

        async function resolveIssue(issueId) {
            await db.collection('issues').doc(issueId).update({ status: 'resolved' });
            loadIssues();
            loadStats();
        }

        async function loadCleaningSessions() {
            try {
                const snapshot = await db.collection('cleaning-sessions').orderBy('startTime', 'desc').limit(20).get();
                
                if (snapshot.empty) {
                    document.getElementById('cleaning-sessions').innerHTML = '<tr><td colspan="7" class="empty-state">No cleaning sessions yet</td></tr>';
                } else {
                    let html = '';
                    snapshot.forEach(doc => {
                        const s = doc.data();
                        const date = s.startTime?.toDate?.() || new Date();
                        const duration = s.duration ? `${Math.floor(s.duration/3600)}h ${Math.floor((s.duration%3600)/60)}m` : '-';
                        const statusClass = s.status === 'completed' ? 'confirmed' : 'pending';
                        
                        html += `
                            <tr>
                                <td>${date.toLocaleDateString()}</td>
                                <td>${s.property || '-'}</td>
                                <td>${s.cleaningType || '-'}</td>
                                <td>${s.staffName || '-'}</td>
                                <td>${duration}</td>
                                <td>${s.issuesReported || 0}</td>
                                <td><span class="table__status table__status--${statusClass}">${s.status || 'unknown'}</span></td>
                            </tr>
                        `;
                    });
                    document.getElementById('cleaning-sessions').innerHTML = html;
                }

                // Load inventory alerts
                const alertsSnapshot = await db.collection('inventory-alerts').where('status', '==', 'pending').get();
                
                if (alertsSnapshot.empty) {
                    document.getElementById('inventory-alerts').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">check_circle</span><p>No inventory alerts</p></div>';
                } else {
                    let alertsHtml = '';
                    alertsSnapshot.forEach(doc => {
                        const a = doc.data();
                        const date = a.reportedAt?.toDate?.() || new Date();
                        const items = a.items || [];
                        
                        alertsHtml += `
                            <div class="issue-card issue-card--medium" style="background:var(--color-cream);border-radius:10px;padding:20px;margin-bottom:15px;border-left:4px solid var(--color-mustard);">
                                <div class="issue-card__header" style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span class="issue-card__location" style="font-weight:600;">${a.property || 'Unknown'}</span>
                                    <span style="font-size:0.8rem;color:var(--color-text-light);">${date.toLocaleDateString()}</span>
                                </div>
                                <p style="color:var(--color-text-light);font-size:0.9rem;margin-bottom:10px;">Low stock items:</p>
                                <ul style="margin-left:20px;">
                                    ${items.map(i => `<li>${i.name}: ${i.count} remaining</li>`).join('')}
                                </ul>
                                <button class="table__action" style="margin-top:15px;" onclick="resolveAlert('${doc.id}')">Mark Resolved</button>
                            </div>
                        `;
                    });
                    document.getElementById('inventory-alerts').innerHTML = alertsHtml;
                }
            } catch (error) {
                console.error('Error loading cleaning sessions:', error);
            }
        }

        async function resolveAlert(alertId) {
            await db.collection('inventory-alerts').doc(alertId).update({ status: 'resolved' });
            loadCleaningSessions();
        }

        function viewBooking(bookingId) {
            alert('Booking details for: ' + bookingId);
            // You can expand this to show a modal with full booking details
        }
    </script>
</body>
</html>
