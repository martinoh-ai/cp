<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Area | Masia Can Pares</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/v1/66d829452bae803f6b32068e/8fb7c7fc-6e43-406c-b1c0-a65a59062cf6/CanPares_2-01.png?format=100w">
    <style>
        :root {
            --color-cream: #F5F0E1;
            --color-mauve: #A07A7E;
            --color-mustard: #E9B84A;
            --color-sage: #2D4A3E;
            --color-terracotta: #A65D57;
            --color-charcoal: #722F37;
            --color-text: #2C2825;
            --color-text-light: #6B635A;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: 'DM Sans', sans-serif;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: #f8f7f4; color: var(--color-text); line-height: 1.6; }

        /* Loading */
        .loading-screen { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-screen.hidden { display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--color-charcoal); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login Required */
        .login-required { display: none; min-height: 100vh; align-items: center; justify-content: center; flex-direction: column; gap: 20px; padding: 40px; text-align: center; }
        .login-required.show { display: flex; }
        .login-required h1 { font-family: var(--font-display); font-size: 1.5rem; }
        .login-required a { padding: 15px 30px; background: var(--color-charcoal); color: white; text-decoration: none; font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.show { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--color-charcoal); color: white; position: fixed; top: 0; left: 0; bottom: 0; display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s; }
        .sidebar__header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar__logo { height: 40px; filter: brightness(0) invert(1); }
        .sidebar__nav { flex: 1; padding: 20px 0; overflow-y: auto; }
        .sidebar__section { margin-bottom: 25px; }
        .sidebar__section-title { padding: 0 20px; font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; opacity: 0.5; margin-bottom: 10px; }
        .sidebar__link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; position: relative; }
        .sidebar__link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar__link.active { background: rgba(255,255,255,0.1); color: white; }
        .sidebar__link.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--color-mustard); }
        .sidebar__link .material-symbols-outlined { font-size: 20px; }
        .sidebar__badge { margin-left: auto; background: var(--color-terracotta); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; }
        .sidebar__badge--warning { background: var(--color-mustard); color: var(--color-charcoal); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .sidebar__footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar__user { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .sidebar__avatar { width: 42px; height: 42px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .sidebar__user-info { flex: 1; }
        .sidebar__user-name { font-weight: 500; }
        .sidebar__user-email { font-size: 0.75rem; opacity: 0.6; }
        .sidebar__logout { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; color: white; font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .sidebar__logout:hover { background: rgba(255,255,255,0.15); }

        /* Mobile menu */
        .mobile-menu { display: none; position: fixed; top: 0; left: 0; right: 0; background: var(--color-charcoal); color: white; padding: 15px 20px; z-index: 99; }
        .mobile-menu__toggle { background: none; border: none; color: white; cursor: pointer; }

        /* Main */
        .main { flex: 1; margin-left: 280px; min-height: 100vh; }
        .main__header { background: white; padding: 25px 35px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; }
        .main__title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; }
        .main__content { padding: 35px; }

        /* Alert Banner */
        .alert-banner { background: linear-gradient(135deg, var(--color-mustard) 0%, #d4a43d 100%); color: var(--color-charcoal); padding: 18px 25px; border-radius: 12px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .alert-banner .material-symbols-outlined { font-size: 28px; }
        .alert-banner__content { flex: 1; }
        .alert-banner__title { font-weight: 600; margin-bottom: 3px; }
        .alert-banner__text { font-size: 0.9rem; opacity: 0.85; }
        .alert-banner__btn { padding: 10px 20px; background: var(--color-charcoal); color: white; border: none; border-radius: 6px; font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; white-space: nowrap; }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .card__header { padding: 20px 25px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; }
        .card__title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card__title .material-symbols-outlined { color: var(--color-charcoal); }
        .card__body { padding: 25px; }
        .card__body--flush { padding: 0; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 12px; padding: 22px; text-align: center; }
        .stat-card__icon { width: 50px; height: 50px; margin: 0 auto 12px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .stat-card__icon--sage { background: rgba(45, 74, 62, 0.1); color: var(--color-sage); }
        .stat-card__icon--terracotta { background: rgba(166, 93, 87, 0.1); color: var(--color-terracotta); }
        .stat-card__icon--mustard { background: rgba(233, 184, 74, 0.15); color: #9a7a00; }
        .stat-card__icon--charcoal { background: rgba(114, 47, 55, 0.1); color: var(--color-charcoal); }
        .stat-card__value { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .stat-card__label { font-size: 0.8rem; color: var(--color-text-light); }
        .stat-card--alert { border: 2px solid var(--color-mustard); }

        /* Booking Card */
        .booking-card { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .booking-card__section h4 { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-text-light); margin-bottom: 12px; }
        .booking-card__row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .booking-card__row:last-child { border-bottom: none; }
        .booking-card__label { color: var(--color-text-light); }
        .booking-card__value { font-weight: 500; }

        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .quick-action { padding: 20px; background: var(--color-cream); border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.3s; border: none; width: 100%; }
        .quick-action:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .quick-action--urgent { background: linear-gradient(135deg, var(--color-mustard) 0%, var(--color-terracotta) 100%); color: white; }
        .quick-action .material-symbols-outlined { font-size: 28px; margin-bottom: 10px; display: block; }
        .quick-action__label { font-size: 0.85rem; font-weight: 500; }
        .quick-action__badge { font-size: 0.65rem; margin-top: 5px; opacity: 0.7; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group--full { grid-column: 1 / -1; }
        .form-label { display: block; font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-light); margin-bottom: 8px; }
        .form-label--required::after { content: ' *'; color: var(--color-terracotta); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border: 1px solid rgba(0,0,0,0.12); border-radius: 8px; font-family: var(--font-body); font-size: 0.95rem; transition: border-color 0.3s; background: white; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--color-charcoal); }
        .form-textarea { min-height: 100px; resize: vertical; }

        /* File Upload */
        .file-upload { border: 2px dashed rgba(0,0,0,0.15); border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .file-upload:hover { border-color: var(--color-charcoal); background: rgba(0,0,0,0.02); }
        .file-upload.has-file { border-color: var(--color-sage); background: rgba(45, 74, 62, 0.05); }
        .file-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .file-upload__icon { font-size: 40px; color: var(--color-text-light); margin-bottom: 10px; }
        .file-upload__text { font-size: 0.9rem; color: var(--color-text-light); }
        .file-upload__preview { margin-top: 15px; }
        .file-upload__preview img { max-height: 100px; border-radius: 8px; }
        .file-upload__filename { font-size: 0.85rem; color: var(--color-sage); font-weight: 500; }

        /* Guest Card */
        .guest-card { background: var(--color-cream); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .guest-card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .guest-card__title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .guest-card__status { padding: 5px 12px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; }
        .guest-card__status--incomplete { background: rgba(233, 184, 74, 0.2); color: #9a7a00; }
        .guest-card__status--complete { background: rgba(45, 74, 62, 0.15); color: var(--color-sage); }
        .guest-card__remove { background: none; border: none; color: var(--color-terracotta); cursor: pointer; padding: 5px; }

        /* Progress */
        .progress-bar { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .progress-bar__fill { height: 100%; background: linear-gradient(90deg, var(--color-sage), var(--color-mustard)); border-radius: 4px; transition: width 0.5s; }

        /* Messages */
        .messages-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 500px; }
        .messages-list { background: var(--color-cream); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .messages-list__header { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.08); font-weight: 600; }
        .messages-list__items { flex: 1; overflow-y: auto; }
        .message-preview { padding: 15px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s; }
        .message-preview:hover, .message-preview.active { background: rgba(255,255,255,0.5); }
        .message-preview__sender { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
        .message-preview__text { font-size: 0.8rem; color: var(--color-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-preview__time { font-size: 0.7rem; color: var(--color-text-light); margin-top: 5px; }

        .chat-container { background: white; border-radius: 10px; display: flex; flex-direction: column; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 15px; }
        .chat-header__avatar { width: 40px; height: 40px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .chat-header__info h4 { font-weight: 600; }
        .chat-header__info p { font-size: 0.8rem; color: var(--color-text-light); }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { max-width: 75%; }
        .chat-message--received { align-self: flex-start; }
        .chat-message--sent { align-self: flex-end; }
        .chat-message__bubble { padding: 12px 16px; border-radius: 16px; font-size: 0.9rem; line-height: 1.5; }
        .chat-message--received .chat-message__bubble { background: var(--color-cream); border-bottom-left-radius: 4px; }
        .chat-message--sent .chat-message__bubble { background: var(--color-charcoal); color: white; border-bottom-right-radius: 4px; }
        .chat-message__time { font-size: 0.65rem; color: var(--color-text-light); margin-top: 5px; }
        .chat-message--sent .chat-message__time { text-align: right; }
        .chat-input { padding: 15px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 12px 16px; border: 1px solid rgba(0,0,0,0.12); border-radius: 25px; font-size: 0.9rem; }
        .chat-input input:focus { outline: none; border-color: var(--color-charcoal); }
        .chat-input button { width: 44px; height: 44px; background: var(--color-charcoal); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }

        /* Documents Grid */
        .documents-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .document-card { background: var(--color-cream); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .document-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .document-card .material-symbols-outlined { font-size: 40px; color: var(--color-charcoal); margin-bottom: 12px; }
        .document-card__name { font-weight: 600; margin-bottom: 5px; }
        .document-card__size { font-size: 0.75rem; color: var(--color-text-light); }

        /* Payment Section */
        .payment-summary { background: var(--color-cream); border-radius: 10px; padding: 25px; }
        .payment-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .payment-row:last-child { border-bottom: none; }
        .payment-row--total { font-weight: 700; font-size: 1.1rem; border-top: 2px solid rgba(0,0,0,0.1); margin-top: 10px; padding-top: 15px; }
        .payment-row--paid { color: var(--color-sage); }
        .payment-row--due { color: var(--color-terracotta); }
        .payment-btn { width: 100%; padding: 16px; margin-top: 20px; background: var(--color-charcoal); color: white; border: none; border-radius: 8px; font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .payment-btn:hover { background: var(--color-terracotta); }

        /* Profile */
        .profile-header { display: flex; align-items: center; gap: 25px; margin-bottom: 30px; }
        .profile-avatar { width: 100px; height: 100px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: 600; }
        .profile-info h2 { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 5px; }
        .profile-info p { color: var(--color-text-light); }

        /* Buttons */
        .btn { padding: 14px 28px; border-radius: 8px; font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn--primary { background: var(--color-charcoal); color: white; }
        .btn--primary:hover { background: var(--color-terracotta); }
        .btn--secondary { background: var(--color-cream); color: var(--color-text); }
        .btn--sage { background: var(--color-sage); color: white; }
        .btn--sage:hover { background: #234a3a; }

        /* WhatsApp Button */
        .whatsapp-float { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); cursor: pointer; z-index: 1000; transition: transform 0.3s; }
        .whatsapp-float:hover { transform: scale(1.1); }
        .whatsapp-float svg { width: 32px; height: 32px; fill: white; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .mobile-menu { display: flex; align-items: center; justify-content: space-between; }
            .main__content { padding: 20px; padding-top: 80px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-actions { grid-template-columns: repeat(2, 1fr); }
            .booking-card { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .messages-container { grid-template-columns: 1fr; height: auto; }
            .documents-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: 1fr; }
            .documents-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Required -->
    <div class="login-required" id="login-required">
        <span class="material-symbols-outlined" style="font-size:64px;color:var(--color-terracotta);">lock</span>
        <h1>Sign In Required</h1>
        <p>Please sign in to access your member area.</p>
        <a href="login-firebase.html">Sign In</a>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Mobile Menu -->
        <div class="mobile-menu">
            <img src="https://images.squarespace-cdn.com/content/v1/66d829452bae803f6b32068e/8fb7c7fc-6e43-406c-b1c0-a65a59062cf6/CanPares_2-01.png?format=500w" alt="Can Pares" style="height:30px;filter:brightness(0) invert(1);">
            <button class="mobile-menu__toggle" onclick="toggleSidebar()">
                <span class="material-symbols-outlined">menu</span>
            </button>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <a href="index.html"><img src="https://images.squarespace-cdn.com/content/v1/66d829452bae803f6b32068e/8fb7c7fc-6e43-406c-b1c0-a65a59062cf6/CanPares_2-01.png?format=500w" alt="Can Pares" class="sidebar__logo"></a>
            </div>
            <nav class="sidebar__nav">
                <div class="sidebar__section">
                    <div class="sidebar__section-title">Your Stay</div>
                    <div class="sidebar__link active" data-tab="overview">
                        <span class="material-symbols-outlined">dashboard</span>
                        Overview
                    </div>
                    <div class="sidebar__link" data-tab="checkin">
                        <span class="material-symbols-outlined">how_to_reg</span>
                        Online Check-in
                        <span class="sidebar__badge sidebar__badge--warning" id="checkin-badge">Required</span>
                    </div>
                    <div class="sidebar__link" data-tab="messages">
                        <span class="material-symbols-outlined">chat</span>
                        Messages
                        <span class="sidebar__badge" id="messages-badge" style="display:none;">0</span>
                    </div>
                    <div class="sidebar__link" data-tab="documents">
                        <span class="material-symbols-outlined">folder</span>
                        Guides & Documents
                    </div>
                </div>
                <div class="sidebar__section">
                    <div class="sidebar__section-title">Manage</div>
                    <div class="sidebar__link" data-tab="experiences">
                        <span class="material-symbols-outlined">explore</span>
                        Book Experiences
                    </div>
                    <div class="sidebar__link" data-tab="payments">
                        <span class="material-symbols-outlined">payments</span>
                        Payments
                    </div>
                    <div class="sidebar__link" data-tab="profile">
                        <span class="material-symbols-outlined">person</span>
                        My Profile
                    </div>
                </div>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__avatar" id="user-avatar">G</div>
                    <div class="sidebar__user-info">
                        <div class="sidebar__user-name" id="user-name">Guest</div>
                        <div class="sidebar__user-email" id="user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0a6d7f6f797e4a6f676b636624696567">[email&#160;protected]</a></div>
                    </div>
                </div>
                <button class="sidebar__logout" onclick="logout()">
                    <span class="material-symbols-outlined">logout</span>
                    Sign Out
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <header class="main__header">
                <h1 class="main__title" id="page-title">Overview</h1>
            </header>

            <div class="main__content">
                <!-- Overview Tab -->
                <div class="tab-content active" id="overview">
                    <div class="alert-banner" id="checkin-alert">
                        <span class="material-symbols-outlined">warning</span>
                        <div class="alert-banner__content">
                            <div class="alert-banner__title">Guest Registration Required</div>
                            <div class="alert-banner__text">Spanish law requires all guest details to be registered before your stay.</div>
                        </div>
                        <button class="alert-banner__btn" onclick="switchTab('checkin')">Complete Now</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card__icon stat-card__icon--sage"><span class="material-symbols-outlined">calendar_today</span></div>
                            <div class="stat-card__value" id="stat-days">-</div>
                            <div class="stat-card__label">Days until arrival</div>
                        </div>
                        <div class="stat-card stat-card--alert" id="stat-guests-card">
                            <div class="stat-card__icon stat-card__icon--terracotta"><span class="material-symbols-outlined">group</span></div>
                            <div class="stat-card__value" id="stat-guests">0/0</div>
                            <div class="stat-card__label">Guests registered</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon stat-card__icon--mustard"><span class="material-symbols-outlined">euro</span></div>
                            <div class="stat-card__value" id="stat-balance">‚Ç¨0</div>
                            <div class="stat-card__label">Balance due</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon stat-card__icon--charcoal"><span class="material-symbols-outlined">description</span></div>
                            <div class="stat-card__value">4</div>
                            <div class="stat-card__label">Guides available</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">hotel</span> Your Booking</span>
                            <span style="font-family:var(--font-mono);font-size:0.75rem;color:var(--color-text-light);" id="booking-ref">CP-2025-XXXX</span>
                        </div>
                        <div class="card__body">
                            <div class="booking-card">
                                <div class="booking-card__section">
                                    <h4>Stay Details</h4>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Property</span>
                                        <span class="booking-card__value" id="booking-property">Casa Blanca</span>
                                    </div>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Check-in</span>
                                        <span class="booking-card__value" id="booking-checkin">-</span>
                                    </div>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Check-out</span>
                                        <span class="booking-card__value" id="booking-checkout">-</span>
                                    </div>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Guests</span>
                                        <span class="booking-card__value" id="booking-guests">-</span>
                                    </div>
                                </div>
                                <div class="booking-card__section">
                                    <h4>Payment Status</h4>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Total</span>
                                        <span class="booking-card__value" id="booking-total">‚Ç¨0</span>
                                    </div>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Paid</span>
                                        <span class="booking-card__value" style="color:var(--color-sage);" id="booking-paid">‚Ç¨0</span>
                                    </div>
                                    <div class="booking-card__row">
                                        <span class="booking-card__label">Balance Due</span>
                                        <span class="booking-card__value" style="color:var(--color-terracotta);" id="booking-due">‚Ç¨0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">bolt</span> Quick Actions</span>
                        </div>
                        <div class="card__body">
                            <div class="quick-actions">
                                <button class="quick-action quick-action--urgent" onclick="switchTab('checkin')">
                                    <span class="material-symbols-outlined">how_to_reg</span>
                                    <span class="quick-action__label">Register Guests</span>
                                    <span class="quick-action__badge">Required</span>
                                </button>
                                <button class="quick-action" onclick="switchTab('documents')">
                                    <span class="material-symbols-outlined">menu_book</span>
                                    <span class="quick-action__label">House Guide</span>
                                </button>
                                <button class="quick-action" onclick="switchTab('messages')">
                                    <span class="material-symbols-outlined">chat</span>
                                    <span class="quick-action__label">Message Host</span>
                                </button>
                                <button class="quick-action" onclick="switchTab('experiences')">
                                    <span class="material-symbols-outlined">wine_bar</span>
                                    <span class="quick-action__label">Experiences</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check-in Tab -->
                <div class="tab-content" id="checkin">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">gavel</span> Legal Requirement</span>
                        </div>
                        <div class="card__body">
                            <p style="margin-bottom:15px;">Spanish law requires all accommodation providers to register guest information. All guests aged 14 and over must provide their details and a valid ID document.</p>
                            <div style="background:var(--color-cream);padding:15px;border-radius:8px;display:flex;align-items:center;gap:10px;">
                                <span class="material-symbols-outlined" style="color:var(--color-terracotta);">schedule</span>
                                <span>Please complete registration <strong>before your check-in date</strong>.</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">group</span> Guest Registration</span>
                            <button class="btn btn--secondary" onclick="addGuest()">
                                <span class="material-symbols-outlined">add</span> Add Guest
                            </button>
                        </div>
                        <div class="card__body">
                            <div style="margin-bottom:20px;">
                                <div class="progress-bar">
                                    <div class="progress-bar__fill" id="checkin-progress" style="width:0%;"></div>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                                    <span id="checkin-count">0 of 0 guests registered</span>
                                    <span style="color:var(--color-text-light);">Complete all to proceed</span>
                                </div>
                            </div>
                            <div id="guests-container">
                                <!-- Guest cards will be added here -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">info</span> Arrival Information</span>
                        </div>
                        <div class="card__body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Estimated Arrival Time</label>
                                    <input type="time" class="form-input" id="arrival-time" value="16:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mode of Transport</label>
                                    <select class="form-select" id="transport">
                                        <option value="car">Rental Car</option>
                                        <option value="taxi">Taxi / Transfer</option>
                                        <option value="own">Own Vehicle</option>
                                    </select>
                                </div>
                                <div class="form-group form-group--full">
                                    <label class="form-label">Special Requests or Dietary Requirements</label>
                                    <textarea class="form-textarea" id="special-requests" placeholder="Let us know if you have any special requirements..."></textarea>
                                </div>
                            </div>
                            <button class="btn btn--sage" onclick="saveCheckin()" id="save-checkin-btn">
                                <span class="material-symbols-outlined">save</span>
                                Save Check-in Information
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div class="tab-content" id="messages">
                    <div class="card">
                        <div class="card__body card__body--flush">
                            <div class="messages-container">
                                <div class="messages-list">
                                    <div class="messages-list__header">Conversations</div>
                                    <div class="messages-list__items">
                                        <div class="message-preview active" onclick="openChat('host')">
                                            <div class="message-preview__sender">Martin (Host)</div>
                                            <div class="message-preview__text">Welcome! Let me know if you need anything.</div>
                                            <div class="message-preview__time">Today</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="chat-container">
                                    <div class="chat-header">
                                        <div class="chat-header__avatar">M</div>
                                        <div class="chat-header__info">
                                            <h4>Martin</h4>
                                            <p>Your Host</p>
                                        </div>
                                    </div>
                                    <div class="chat-messages" id="chat-messages">
                                        <div class="chat-message chat-message--received">
                                            <div class="chat-message__bubble">Welcome to Can Pares! I'm Martin, your host. Feel free to message me here if you have any questions about your stay. üè°</div>
                                            <div class="chat-message__time">Today, 10:00</div>
                                        </div>
                                    </div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="message-input">
                                        <button onclick="sendMessage()">
                                            <span class="material-symbols-outlined">send</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-content" id="documents">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">auto_stories</span> Essential Guides</span>
                        </div>
                        <div class="card__body">
                            <div class="documents-grid">
                                <div class="document-card" onclick="downloadDoc('house-guide')">
                                    <span class="material-symbols-outlined">home</span>
                                    <div class="document-card__name">House Guide</div>
                                    <div class="document-card__size">PDF ‚Ä¢ 2.4 MB</div>
                                </div>
                                <div class="document-card" onclick="downloadDoc('region-guide')">
                                    <span class="material-symbols-outlined">map</span>
                                    <div class="document-card__name">Region Guide</div>
                                    <div class="document-card__size">PDF ‚Ä¢ 3.1 MB</div>
                                </div>
                                <div class="document-card" onclick="downloadDoc('restaurant-guide')">
                                    <span class="material-symbols-outlined">restaurant</span>
                                    <div class="document-card__name">Restaurant Guide</div>
                                    <div class="document-card__size">PDF ‚Ä¢ 1.8 MB</div>
                                </div>
                                <div class="document-card" onclick="downloadDoc('wifi')">
                                    <span class="material-symbols-outlined">wifi</span>
                                    <div class="document-card__name">WiFi & Tech Setup</div>
                                    <div class="document-card__size">PDF ‚Ä¢ 0.5 MB</div>
                                </div>
                                <div class="document-card" onclick="downloadDoc('pool')">
                                    <span class="material-symbols-outlined">pool</span>
                                    <div class="document-card__name">Pool & Garden</div>
                                    <div class="document-card__size">PDF ‚Ä¢ 0.8 MB</div>
                                </div>
                                <div class="document-card" onclick="downloadDoc('emergency')">
                                    <span class="material-symbols-outlined">emergency</span>
                                    <div class="document-card__name">Emergency Contacts</div>
                                    <div class="document-card__size">PDF ‚Ä¢ 0.2 MB</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Experiences Tab -->
                <div class="tab-content" id="experiences">
                    <div class="card">
                        <div class="card__body" style="text-align:center;padding:60px;">
                            <span class="material-symbols-outlined" style="font-size:64px;color:var(--color-charcoal);margin-bottom:20px;">wine_bar</span>
                            <h3 style="margin-bottom:10px;">Curated Experiences</h3>
                            <p style="color:var(--color-text-light);margin-bottom:25px;">Discover wine tastings, sailing trips, cooking classes and more.</p>
                            <a href="experiences.html" class="btn btn--primary">Browse Experiences</a>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div class="tab-content" id="payments">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">receipt_long</span> Payment Summary</span>
                        </div>
                        <div class="card__body">
                            <div class="payment-summary">
                                <div class="payment-row">
                                    <span>Accommodation</span>
                                    <span id="pay-accommodation">‚Ç¨0</span>
                                </div>
                                <div class="payment-row">
                                    <span>Cleaning Fee</span>
                                    <span id="pay-cleaning">‚Ç¨0</span>
                                </div>
                                <div class="payment-row">
                                    <span>Tourist Tax</span>
                                    <span id="pay-tax">‚Ç¨0</span>
                                </div>
                                <div class="payment-row payment-row--total">
                                    <span>Total</span>
                                    <span id="pay-total">‚Ç¨0</span>
                                </div>
                                <div class="payment-row payment-row--paid">
                                    <span>Deposit Paid</span>
                                    <span id="pay-paid">‚Ç¨0</span>
                                </div>
                                <div class="payment-row payment-row--due">
                                    <span>Balance Due</span>
                                    <span id="pay-due">‚Ç¨0</span>
                                </div>
                                <button class="payment-btn" id="pay-btn" onclick="makePayment()">
                                    <span class="material-symbols-outlined">credit_card</span>
                                    Pay Balance Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-content" id="profile">
                    <div class="card">
                        <div class="card__body">
                            <div class="profile-header">
                                <div class="profile-avatar" id="profile-avatar">G</div>
                                <div class="profile-info">
                                    <h2 id="profile-name">Guest</h2>
                                    <p id="profile-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cbacbeaeb8bf8baea6aaa2a7e5a8a4a6">[email&#160;protected]</a></p>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-input" id="profile-firstname">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-input" id="profile-lastname">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="profile-email-input" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="profile-phone">
                                </div>
                            </div>
                            <button class="btn btn--primary" onclick="saveProfile()">
                                <span class="material-symbols-outlined">save</span>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- WhatsApp Float -->
    <a href="#" id="whatsapp-btn" class="whatsapp-float" target="_blank">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    </a>

    <!-- Firebase SDK -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // =====================================================
        // üî• CONFIGURATION - REMPLACEZ AVEC VOS VALEURS
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlqtcXUqEctwsvLbXzGOenleNPDwOj4n4",
            authDomain: "masia-can-pares.firebaseapp.com",
            projectId: "masia-can-pares",
            storageBucket: "masia-can-pares.firebasestorage.app",
            messagingSenderId: "898469617158",
            appId: "1:898469617158:web:94f57c383501f81b9d2d87"
        };

        // üì± WHATSAPP
        const WHATSAPP_NUMBER = "34612345678";

        // üí≥ PAYMENT LINK (Qonto ou autre)
        const PAYMENT_LINK = "https://pay.qonto.com/votre-lien";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // =====================================================
        // STATE
        // =====================================================
        let currentUser = null;
        let currentBooking = null;
        let currentCheckin = null;
        let guestCount = 0;
        let guests = [];

        // =====================================================
        // AUTH
        // =====================================================
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-screen').classList.add('hidden');
            
            if (user) {
                currentUser = user;
                document.getElementById('dashboard').classList.add('show');
                initDashboard();
            } else {
                document.getElementById('login-required').classList.add('show');
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login-firebase.html';
            });
        }

        // =====================================================
        // INIT
        // =====================================================
        async function initDashboard() {
            // Load user profile
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.exists ? userDoc.data() : {};
            
            const name = userData.firstName ? `${userData.firstName} ${userData.lastName || ''}` : currentUser.displayName || 'Guest';
            const initials = name.split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase();
            
            document.getElementById('user-name').textContent = name;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('profile-name').textContent = name;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-avatar').textContent = initials;
            document.getElementById('profile-firstname').value = userData.firstName || '';
            document.getElementById('profile-lastname').value = userData.lastName || '';
            document.getElementById('profile-email-input').value = currentUser.email;
            document.getElementById('profile-phone').value = userData.phone || '';

            // WhatsApp link
            document.getElementById('whatsapp-btn').href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(`Hi! I'm ${name}, I have a booking at Can Pares.`)}`;

            // Load booking
            await loadBooking();
            await loadCheckin();
            await loadMessages();

            // Tab navigation
            document.querySelectorAll('.sidebar__link').forEach(link => {
                link.addEventListener('click', () => {
                    switchTab(link.dataset.tab);
                });
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.sidebar__link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            const titles = {
                overview: 'Overview',
                checkin: 'Online Check-in',
                messages: 'Messages',
                documents: 'Guides & Documents',
                experiences: 'Book Experiences',
                payments: 'Payments',
                profile: 'My Profile'
            };
            document.getElementById('page-title').textContent = titles[tabId] || 'Overview';
            
            // Close mobile sidebar
            document.getElementById('sidebar').classList.remove('open');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // =====================================================
        // BOOKING
        // =====================================================
        async function loadBooking() {
            try {
                const bookingsQuery = await db.collection('bookings')
                    .where('guestId', '==', currentUser.uid)
                    .orderBy('checkIn', 'desc')
                    .limit(1)
                    .get();

                if (bookingsQuery.empty) {
                    // No booking found - check by email
                    const emailQuery = await db.collection('bookings')
                        .where('guestEmail', '==', currentUser.email)
                        .orderBy('checkIn', 'desc')
                        .limit(1)
                        .get();
                    
                    if (!emailQuery.empty) {
                        currentBooking = { id: emailQuery.docs[0].id, ...emailQuery.docs[0].data() };
                        // Link booking to user
                        await db.collection('bookings').doc(currentBooking.id).update({ guestId: currentUser.uid });
                    }
                } else {
                    currentBooking = { id: bookingsQuery.docs[0].id, ...bookingsQuery.docs[0].data() };
                }

                if (currentBooking) {
                    updateBookingDisplay();
                }
            } catch (error) {
                console.error('Error loading booking:', error);
            }
        }

        function updateBookingDisplay() {
            if (!currentBooking) return;

            const checkIn = currentBooking.checkIn?.toDate?.() || new Date(currentBooking.checkIn);
            const checkOut = currentBooking.checkOut?.toDate?.() || new Date(currentBooking.checkOut);
            const today = new Date();
            const daysUntil = Math.ceil((checkIn - today) / (1000 * 60 * 60 * 24));
            
            document.getElementById('booking-ref').textContent = currentBooking.refCode || currentBooking.id.slice(0,12);
            document.getElementById('booking-property').textContent = currentBooking.property || 'Casa Blanca';
            document.getElementById('booking-checkin').textContent = checkIn.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
            document.getElementById('booking-checkout').textContent = checkOut.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
            document.getElementById('booking-guests').textContent = `${currentBooking.guests || 1} guests`;
            
            document.getElementById('stat-days').textContent = daysUntil > 0 ? daysUntil : 'Today!';
            guestCount = currentBooking.guests || 1;
            
            // Payment
            const total = currentBooking.totalAmount || 0;
            const paid = currentBooking.paidAmount || 0;
            const due = total - paid;
            
            document.getElementById('booking-total').textContent = `‚Ç¨${total}`;
            document.getElementById('booking-paid').textContent = `‚Ç¨${paid}`;
            document.getElementById('booking-due').textContent = `‚Ç¨${due}`;
            document.getElementById('stat-balance').textContent = `‚Ç¨${due}`;
            
            // Payment tab
            document.getElementById('pay-accommodation').textContent = `‚Ç¨${currentBooking.accommodationAmount || total}`;
            document.getElementById('pay-cleaning').textContent = `‚Ç¨${currentBooking.cleaningFee || 0}`;
            document.getElementById('pay-tax').textContent = `‚Ç¨${currentBooking.touristTax || 0}`;
            document.getElementById('pay-total').textContent = `‚Ç¨${total}`;
            document.getElementById('pay-paid').textContent = `‚Ç¨${paid}`;
            document.getElementById('pay-due').textContent = `‚Ç¨${due}`;
            
            if (due <= 0) {
                document.getElementById('pay-btn').textContent = 'Fully Paid ‚úì';
                document.getElementById('pay-btn').disabled = true;
            }
        }

        // =====================================================
        // CHECK-IN
        // =====================================================
        async function loadCheckin() {
            if (!currentBooking) {
                initGuestForms();
                return;
            }

            try {
                const checkinDoc = await db.collection('checkins').doc(currentBooking.id).get();
                
                if (checkinDoc.exists) {
                    currentCheckin = checkinDoc.data();
                    guests = currentCheckin.guests || [];
                    
                    document.getElementById('arrival-time').value = currentCheckin.arrivalTime || '16:00';
                    document.getElementById('transport').value = currentCheckin.transport || 'car';
                    document.getElementById('special-requests').value = currentCheckin.specialRequests || '';
                }
                
                initGuestForms();
                updateCheckinProgress();
            } catch (error) {
                console.error('Error loading checkin:', error);
                initGuestForms();
            }
        }

        function initGuestForms() {
            const container = document.getElementById('guests-container');
            container.innerHTML = '';
            
            for (let i = 0; i < guestCount; i++) {
                const guestData = guests[i] || {};
                addGuestCard(i + 1, guestData);
            }
            
            updateCheckinProgress();
        }

        function addGuestCard(num, data = {}) {
            const container = document.getElementById('guests-container');
            const isComplete = data.firstName && data.lastName && data.dateOfBirth && data.nationality && data.idType && data.idNumber && data.idDocumentUrl;
            
            const card = document.createElement('div');
            card.className = 'guest-card';
            card.id = `guest-${num}`;
            card.innerHTML = `
                <div class="guest-card__header">
                    <span class="guest-card__title">
                        <span class="material-symbols-outlined">person</span>
                        Guest ${num} ${num === 1 ? '(Primary)' : ''}
                    </span>
                    <span class="guest-card__status guest-card__status--${isComplete ? 'complete' : 'incomplete'}">
                        ${isComplete ? '‚úì Complete' : '‚ö† Incomplete'}
                    </span>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label form-label--required">First Name</label>
                        <input type="text" class="form-input guest-input" data-guest="${num}" data-field="firstName" value="${data.firstName || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label--required">Last Name</label>
                        <input type="text" class="form-input guest-input" data-guest="${num}" data-field="lastName" value="${data.lastName || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label--required">Date of Birth</label>
                        <input type="date" class="form-input guest-input" data-guest="${num}" data-field="dateOfBirth" value="${data.dateOfBirth || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label--required">Nationality</label>
                        <select class="form-select guest-input" data-guest="${num}" data-field="nationality" required>
                            <option value="">Select...</option>
                            <option value="FR" ${data.nationality === 'FR' ? 'selected' : ''}>France</option>
                            <option value="GB" ${data.nationality === 'GB' ? 'selected' : ''}>United Kingdom</option>
                            <option value="DE" ${data.nationality === 'DE' ? 'selected' : ''}>Germany</option>
                            <option value="ES" ${data.nationality === 'ES' ? 'selected' : ''}>Spain</option>
                            <option value="US" ${data.nationality === 'US' ? 'selected' : ''}>United States</option>
                            <option value="IT" ${data.nationality === 'IT' ? 'selected' : ''}>Italy</option>
                            <option value="NL" ${data.nationality === 'NL' ? 'selected' : ''}>Netherlands</option>
                            <option value="BE" ${data.nationality === 'BE' ? 'selected' : ''}>Belgium</option>
                            <option value="CH" ${data.nationality === 'CH' ? 'selected' : ''}>Switzerland</option>
                            <option value="OTHER" ${data.nationality === 'OTHER' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label--required">ID Document Type</label>
                        <select class="form-select guest-input" data-guest="${num}" data-field="idType" required>
                            <option value="">Select...</option>
                            <option value="passport" ${data.idType === 'passport' ? 'selected' : ''}>Passport</option>
                            <option value="national_id" ${data.idType === 'national_id' ? 'selected' : ''}>National ID Card</option>
                            <option value="driving_license" ${data.idType === 'driving_license' ? 'selected' : ''}>EU Driving License</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label--required">ID Number</label>
                        <input type="text" class="form-input guest-input" data-guest="${num}" data-field="idNumber" value="${data.idNumber || ''}" placeholder="e.g. AB123456" required>
                    </div>
                    <div class="form-group form-group--full">
                        <label class="form-label form-label--required">ID Document Photo</label>
                        <div class="file-upload ${data.idDocumentUrl ? 'has-file' : ''}" id="upload-${num}">
                            <input type="file" accept="image/*,application/pdf" onchange="uploadIdDocument(${num}, this)">
                            <span class="material-symbols-outlined file-upload__icon">${data.idDocumentUrl ? 'check_circle' : 'cloud_upload'}</span>
                            <div class="file-upload__text">${data.idDocumentUrl ? 'Document uploaded' : 'Click or drag to upload'}</div>
                            ${data.idDocumentUrl ? `<div class="file-upload__filename">‚úì Document saved</div>` : '<div class="file-upload__filename" style="font-size:0.75rem;">JPG, PNG or PDF ‚Ä¢ Max 5MB</div>'}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);

            // Add event listeners for auto-save
            card.querySelectorAll('.guest-input').forEach(input => {
                input.addEventListener('change', () => updateGuestData(num));
            });
        }

        function addGuest() {
            guestCount++;
            addGuestCard(guestCount);
            updateCheckinProgress();
        }

        function updateGuestData(num) {
            const index = num - 1;
            if (!guests[index]) guests[index] = {};
            
            const card = document.getElementById(`guest-${num}`);
            guests[index] = {
                ...guests[index],
                firstName: card.querySelector('[data-field="firstName"]').value,
                lastName: card.querySelector('[data-field="lastName"]').value,
                dateOfBirth: card.querySelector('[data-field="dateOfBirth"]').value,
                nationality: card.querySelector('[data-field="nationality"]').value,
                idType: card.querySelector('[data-field="idType"]').value,
                idNumber: card.querySelector('[data-field="idNumber"]').value
            };
            
            updateCheckinProgress();
        }

        async function uploadIdDocument(guestNum, input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Maximum 5MB.');
                return;
            }

            const uploadDiv = document.getElementById(`upload-${guestNum}`);
            uploadDiv.querySelector('.file-upload__text').textContent = 'Uploading...';

            try {
                const fileName = `${currentBooking?.id || currentUser.uid}_guest${guestNum}_${Date.now()}.${file.name.split('.').pop()}`;
                const ref = storage.ref(`id-documents/${fileName}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();

                const index = guestNum - 1;
                if (!guests[index]) guests[index] = {};
                guests[index].idDocumentUrl = url;

                uploadDiv.classList.add('has-file');
                uploadDiv.querySelector('.material-symbols-outlined').textContent = 'check_circle';
                uploadDiv.querySelector('.file-upload__text').textContent = 'Document uploaded';
                
                updateCheckinProgress();
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
                uploadDiv.querySelector('.file-upload__text').textContent = 'Click or drag to upload';
            }
        }

        function updateCheckinProgress() {
            let complete = 0;
            guests.forEach((g, i) => {
                const isComplete = g.firstName && g.lastName && g.dateOfBirth && g.nationality && g.idType && g.idNumber && g.idDocumentUrl;
                if (isComplete) complete++;
                
                const card = document.getElementById(`guest-${i + 1}`);
                if (card) {
                    const status = card.querySelector('.guest-card__status');
                    status.className = `guest-card__status guest-card__status--${isComplete ? 'complete' : 'incomplete'}`;
                    status.textContent = isComplete ? '‚úì Complete' : '‚ö† Incomplete';
                }
            });

            const total = Math.max(guestCount, guests.length);
            const progress = total > 0 ? (complete / total) * 100 : 0;
            
            document.getElementById('checkin-progress').style.width = `${progress}%`;
            document.getElementById('checkin-count').textContent = `${complete} of ${total} guests registered`;
            document.getElementById('stat-guests').textContent = `${complete}/${total}`;

            // Update alerts
            if (complete >= total && total > 0) {
                document.getElementById('checkin-alert').style.display = 'none';
                document.getElementById('checkin-badge').style.display = 'none';
                document.getElementById('stat-guests-card').classList.remove('stat-card--alert');
            } else {
                document.getElementById('checkin-alert').style.display = 'flex';
                document.getElementById('checkin-badge').style.display = 'inline';
            }
        }

        async function saveCheckin() {
            if (!currentBooking) {
                alert('No booking found. Please contact support.');
                return;
            }

            const btn = document.getElementById('save-checkin-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> Saving...';

            try {
                const checkinData = {
                    bookingId: currentBooking.id,
                    guestId: currentUser.uid,
                    guests: guests,
                    arrivalTime: document.getElementById('arrival-time').value,
                    transport: document.getElementById('transport').value,
                    specialRequests: document.getElementById('special-requests').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: guests.every(g => g.firstName && g.lastName && g.dateOfBirth && g.nationality && g.idType && g.idNumber && g.idDocumentUrl) ? 'complete' : 'incomplete'
                };

                await db.collection('checkins').doc(currentBooking.id).set(checkinData, { merge: true });
                
                btn.innerHTML = '<span class="material-symbols-outlined">check</span> Saved!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Check-in Information';
                }, 2000);
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Check-in Information';
            }
        }

        // =====================================================
        // MESSAGES
        // =====================================================
        async function loadMessages() {
            if (!currentBooking) return;

            try {
                // Create or get conversation
                const convRef = db.collection('conversations').doc(currentBooking.id);
                const convDoc = await convRef.get();

                if (!convDoc.exists) {
                    await convRef.set({
                        guestId: currentUser.uid,
                        guestName: document.getElementById('user-name').textContent,
                        guestPhone: document.getElementById('profile-phone').value || '',
                        bookingRef: currentBooking.refCode || currentBooking.id,
                        lastMessage: 'Conversation started',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        unreadByHost: 0,
                        unreadByGuest: 0
                    });
                }

                // Load messages
                db.collection('conversations').doc(currentBooking.id).collection('messages')
                    .orderBy('timestamp')
                    .onSnapshot(snapshot => {
                        const container = document.getElementById('chat-messages');
                        container.innerHTML = '';
                        
                        snapshot.forEach(doc => {
                            const m = doc.data();
                            const isHost = m.senderRole === 'admin' || m.senderId === 'admin';
                            const time = m.timestamp?.toDate?.() || new Date();
                            
                            container.innerHTML += `
                                <div class="chat-message chat-message--${isHost ? 'received' : 'sent'}">
                                    <div class="chat-message__bubble">${m.text}</div>
                                    <div class="chat-message__time">${time.toLocaleString()}</div>
                                </div>
                            `;
                        });

                        container.scrollTop = container.scrollHeight;
                    });

                // Mark as read
                await convRef.update({ unreadByGuest: 0 });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentBooking) return;

            input.value = '';

            try {
                await db.collection('conversations').doc(currentBooking.id).collection('messages').add({
                    text,
                    senderId: currentUser.uid,
                    senderRole: 'guest',
                    senderName: document.getElementById('user-name').textContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                await db.collection('conversations').doc(currentBooking.id).update({
                    lastMessage: text,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    unreadByHost: firebase.firestore.FieldValue.increment(1)
                });
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Enter to send
        document.getElementById('message-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // =====================================================
        // PROFILE
        // =====================================================
        async function saveProfile() {
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    firstName: document.getElementById('profile-firstname').value,
                    lastName: document.getElementById('profile-lastname').value,
                    phone: document.getElementById('profile-phone').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert('Profile saved!');
                
                // Update display
                const name = `${document.getElementById('profile-firstname').value} ${document.getElementById('profile-lastname').value}`;
                document.getElementById('user-name').textContent = name;
                document.getElementById('profile-name').textContent = name;
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile.');
            }
        }

        // =====================================================
        // PAYMENT
        // =====================================================
        function makePayment() {
            window.open(PAYMENT_LINK, '_blank');
        }

        // =======================================